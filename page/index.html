<!DOCTYPE html>
<html><head>
  <meta http-equiv='Content-Type' content='text/html; charset=utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=0.4, maximum-scale=0.4, user-scalable=no' />
</head><body>
<style>
/* latin */
@font-face {
  font-family: 'Varela Round';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(/static/VarelaRound.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

html, body {
  height: 100%;
  margin: 0;
  overflow: hidden;
  color: #222;
  background: #fdfdfd;
}
* {
  font-family: "Varela Round", sans-serif;
  user-select: none;
}
#container {
  min-height: 100%;
  margin: 0 auto;
  width: 100%;
}

#icon-btns-container {
  position: absolute;
  top: 36px;
  padding: 0 20px;
}
#icon-btns-container > div {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  line-height: 80px;
  text-align: center;
  font-size: 60px;
  background: rgba(220, 220, 220, 80%);
  transition: background-color 0.2s ease;
}
#icon-btns-container > div:active {
  background: rgba(200, 200, 200, 80%);
}

.list {
  margin: 40px 40px;
}
.list > div {
  width: 100%;
  display: flex;
}
.list > div.fg {
  margin-top: -160px;
}
.list .bubble {
  display: inline-block;
  flex: 1 1 160px;
  height: 160px;
  line-height: 160px;
  text-align: center;
  font-size: 60px;
  overflow: visible;
}
.list .bubble > div.content {
  background: rgba(220, 220, 220, 80%);
  border-radius: 50%;
  display: inline-block;
  position: fixed;
  width: 160px;
  height: 160px;
  transform: translateX(-50%);
  opacity: 1;
  border: 1px solid transparent;
  transition: opacity 0.5s ease, transform 0.5s ease, background 0.5s ease, border-color 0.5s ease;
}
.list .bubble.none > div.content {
  background: rgba(240, 240, 240, 80%);
}
.list .bubble.bingo > div.content {
  background: rgba(128, 216, 48, 80%);
}
.list .bubble.maybe > div.content {
  background: rgba(240, 232, 64, 80%);
}
.list .bubble.hidden > div.content,
.list.hidden .bubble:not(.nohidden) > div.content,
.list.hidden.must .bubble > div.content {
  opacity: 0;
  transform: translateX(-50%) scale(0.5);
  pointer-events: none;
}
.list .bubble.outline > div.content {
  background: rgba(250, 250, 250, 80%);
}
.list .bubble.outline:not(.hidden) > div.content {
  opacity: 1;
  transform: translateX(-50%) scale(1);
  border-color: #999;
}
.list .bubble.fast > div.content {
  transition: opacity 0.5s cubic-bezier(0.16, 1, 0.3, 1), transform 0.5s cubic-bezier(0.16, 1, 0.3, 1), background 0.5s cubic-bezier(0.16, 1, 0.3, 1), border-color 0.5s cubic-bezier(0.16, 1, 0.3, 1);
}
.list .bubble.fast-pop > div.content {
  transition: opacity 0.5s ease, transform 0.15s ease, background 0.5s ease, border-color 0.5s ease;
}
.list > .fg > .bubble > div.content {
  background: none;
  z-index: 910;
  pointer-events: none;
}
.list > .fg > .bubble.bingo > div.content {
  color: #164;
}
.list > .fg > .bubble.maybe > div.content {
  color: #664;
}
.list.btn .bubble > div.content {
  transform: translateX(-50%) scale(1.2);
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}
.list.btn .bubble > div.content:active {
  background: rgba(200, 200, 200, 80%);
}
.list.btn.disabled .bubble > div.content {
  background: rgba(240, 240, 240, 80%);
  pointer-events: none;
}
.list .bubble.large > div.content {
  transform: translateX(-50%) scale(1.2);
}

.tune-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  position: relative;
  left: 50%;
  background: #222;
  transform: translate(-50%, -50%);
  opacity: 1;
  border: 2px solid transparent;
  transition: opacity 0.5s ease, transform 0.5s ease, background-color 0.5s ease, border-color 0.5s ease;
}
.tune-dot.ottava {
  top: -10%;
}
.tune-dot.ottava-bassa {
  top: 110%;
}
.list .bubble.hidden > div > div.tune-dot {
  opacity: 0;
  transform: translate(-50%, -50%) scale(0.5);
}
.list .bubble.outline > div > div.tune-dot {
  background-color: transparent;
  border-color: #999;
}

#list-container {
}
#start-btn-container {
  position: absolute;
  top: 30%;
  width: 100%;
}
#text-loading {
  position: absolute;
  top: 30%;
  width: 100%;
  font-size: 54px;
  text-align: center;
  pointer-events: none;
  transform: scale(1);
  opacity: 1;
  transition: opacity 0.5s ease, transform 0.5s ease;
}
#text-loading.hidden {
  transform: scale(0.5);
  opacity: 0;
}
#btn-start {
  transform: scale(1.5);
}
#btns-container {
  width: 100%;
  position: absolute;
  bottom: 0;
}
.list.btn.confirm {
  margin-top: -200px;
}
.list.btn.confirm .bubble {
}
.list.btn.confirm .bubble > div.content {
  width: 83%; /* for the background capsule shape, this will be overridden */
  display: inline-block;
  position: unset;
  transform: scale(1.2);
  border-radius: 80px;
}
.list.btn.confirm.hidden .bubble > div.content {
  transform: scale(0.5);
}

#modal-bg {
  z-index: 990;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
  background: rgba(24, 24, 24, 80%);
  opacity: 1;
  transition: opacity 0.5s ease;
}
#modal-bg.hidden {
  opacity: 0;
}
.modal {
  z-index: 991;
  position: absolute;
  top: 15%;
  left: 10%;
  bottom: 15%;
  right: 10%;
  background: #fdfdfd;
  border-radius: 20px;
  padding: 48px 60px;
  font-size: 36px;
  overflow: scroll;
  opacity: 1;
  transform: scale(1);
  transition: opacity 0.5s ease, transform 0.5s ease;
}
.modal.hidden {
  opacity: 0;
  transform: scale(0.9);
}
.modal p {
  margin: 0 0 0.8ex 0;
}
.modal p.title {
  font-size: 1.5em;
  font-weight: bold;
  text-align: center;
  margin-bottom: 1ex;
}
#modal-bg.hidden, .modal.hidden {
  pointer-events: none;
}
.modal .bottom-shadow {
  width: 100%;
  height: 60px;
  position: sticky;
  bottom: -50px;
  left: 0;
  background: linear-gradient(rgba(253, 253, 253, 0), rgba(253, 253, 253, 1));
}

.modal .list {
  margin: 20px 0;
}
.modal .list .bubble > div {
  transform: translateX(-50%) scale(0.7);
}
.modal .list .bubble.large > div.content {
  transform: translateX(-50%) scale(0.8);
}
.modal .list .tune-dot.ottava {
  top: 5%;
}
.modal .list .tune-dot.ottava-bassa {
  top: 88%;
}

#answer-container {
  margin: 40px 0;
}
#btn-play {
  margin-bottom: 60px;
}
#btn-share {
  padding: 20px;
  background: #cbf4ba;
  border-radius: 20px;
  margin-top: 40px;
  text-align: center;
  transition: background-color 0.2s ease;
}
#btn-share:active {
  background: #abd49a;
}
#btn-share.copied {
  background: #dbf7ca;
}
</style>

<div id='container'>
  <h1 style='font-size: 60px; text-align: center'>Medle #THUMB001</h1>
  <div id='icon-btns-container'>
    <div id='icon-btn-help'>?</div>
  </div>
  <div id='list-container'>
  </div>
  <div id='start-btn-container'>
    <div id='text-loading'>Loading… <span id='text-loading-progress'></span></div>
    <div class='list btn hidden' id='btn-start'>
      <div class='bg'>
        <div class='bubble' onclick='startGame()'>
          <div class='content'></div>
        </div>
      </div>
      <div class='fg'>
        <div class='bubble'><div class='content'>Start</div></div>
      </div>
    </div>
  </div>
  <div id='btns-container'>
    <div class='list btn hidden' id='input-btns-row-1'>
      <div class='bg'>
        <div class='bubble' onclick='input(1)'><div class='content'></div></div>
        <div class='bubble' onclick='input(2)'><div class='content'></div></div>
        <div class='bubble' onclick='input(3)'><div class='content'></div></div>
        <div class='bubble' onclick='input(4)'><div class='content'></div></div>
      </div>
      <div class='fg'>
        <div class='bubble'><div class='content'>1</div></div>
        <div class='bubble'><div class='content'>2</div></div>
        <div class='bubble'><div class='content'>3</div></div>
        <div class='bubble'><div class='content'>4</div></div>
      </div>
    </div>
    <div class='list btn confirm hidden' id='input-btns-confirm'>
      <div class='bg'>
        <div class='bubble' onclick='confirmGuess()'>
          <div id='input-btn-confirm-bg' class='content'></div>
        </div>
      </div>
      <div class='fg'>
        <div class='bubble'><div class='content'>确认</div></div>
      </div>
    </div>
    <div class='list btn confirm hidden' id='input-btns-reveal'>
      <div class='bg'>
        <div class='bubble' onclick='revealAnswer()'>
          <div id='input-btn-reveal-bg' class='content'></div>
        </div>
      </div>
      <div class='fg'>
        <div class='bubble'><div class='content'>谜底</div></div>
      </div>
    </div>
    <div class='list btn hidden must' id='input-btns-row-2'>
      <div class='bg'>
        <div class='bubble' onclick='input(5)'><div class='content'></div></div>
        <div class='bubble' onclick='input(6)'><div class='content'></div></div>
        <div class='bubble' onclick='input(7)'><div class='content'></div></div>
        <div class='bubble nohidden' onclick='input(-1)'>
          <div id='input-btn-del-bg' class='content'></div>
        </div>
      </div>
      <div class='fg'>
        <div class='bubble'><div class='content'>5</div></div>
        <div class='bubble'><div class='content'>6</div></div>
        <div class='bubble'><div class='content'>7</div></div>
        <div class='bubble nohidden'><div class='content'>del</div></div>
      </div>
    </div>
  </div>

  <div id='modal-bg' class='hidden'></div>
  <div class='modal hidden' id='modal-intro'>
    <p class='title'>- Medle 游戏规则 -</p>
    <p>猜出旋律中的每个音符。<p>
    <p>音符用 1 至 7 的数字表示。除此之外，玩家不必具备音乐知识。</p>
    <p>每次猜测后，将针对每个音符给出提示。</p>
    <div class='list intro'>
      <div class='bg'>
        <div class='bubble none'><div class='content'></div></div>
        <div class='bubble bingo'><div class='content'></div></div>
        <div class='bubble none'><div class='content'></div></div>
        <div class='bubble none'><div class='content'></div></div>
        <div class='bubble none'><div class='content'></div></div>
      </div>
      <div class='fg'>
        <div class='bubble'><div class='content'>1</div></div>
        <div class='bubble'><div class='content'>2</div></div>
        <div class='bubble'><div class='content'>3</div></div>
        <div class='bubble'><div class='content'>4</div></div>
        <div class='bubble'><div class='content'>5</div></div>
      </div>
    </div>
    <p style='text-align: center; color: #888'>音符“2”处于谜底中的正确位置。</p>
    <div class='list intro'>
      <div class='bg'>
        <div class='bubble none'><div class='content'></div></div>
        <div class='bubble none'><div class='content'></div></div>
        <div class='bubble maybe'><div class='content'></div></div>
        <div class='bubble none'><div class='content'></div></div>
        <div class='bubble none'><div class='content'></div></div>
      </div>
      <div class='fg'>
        <div class='bubble'><div class='content'>1</div></div>
        <div class='bubble'><div class='content'>2</div></div>
        <div class='bubble'><div class='content'>3</div></div>
        <div class='bubble'><div class='content'>4</div></div>
        <div class='bubble'><div class='content'>5</div></div>
      </div>
    </div>
    <p style='text-align: center; color: #888'>音符“3”出现在谜底中，但并不在猜测的位置上。</p>
    <br>
    <p>若同一音符出现多次，则也会提示多次。</p>
    <div class='list intro'>
      <div class='bg'>
        <div class='bubble maybe'><div class='content'></div></div>
        <div class='bubble maybe'><div class='content'></div></div>
        <div class='bubble none'><div class='content'></div></div>
        <div class='bubble bingo'><div class='content'></div></div>
        <div class='bubble none'><div class='content'></div></div>
        <div class='bubble none'><div class='content'></div></div>
      </div>
      <div class='fg'>
        <div class='bubble'><div class='content'>1</div></div>
        <div class='bubble'><div class='content'>1</div></div>
        <div class='bubble'><div class='content'>1</div></div>
        <div class='bubble'><div class='content'>1</div></div>
        <div class='bubble'><div class='content'>5</div></div>
        <div class='bubble'><div class='content'>6</div></div>
      </div>
    </div>
    <p style='text-align: center; color: #888'>一个音符“1”在正确的位置；除此之外，谜底中还有两个“1”，但都不在猜测为“1”的位置上。</p>
    <br>
    <p>游戏中出现的其余记号只影响发出的声音，不影响游戏规则。</p>
    <div class='list intro'>
      <div class='bg'>
        <div class='bubble bingo'><div class='content'></div></div>
        <div class='bubble none'><div class='content'></div></div>
        <div class='bubble none'><div class='content'></div></div>
        <div class='bubble maybe'><div class='content'></div></div>
        <div class='bubble none'><div class='content'></div></div>
      </div>
      <div class='fg'>
        <div class='bubble'><div class='content'>1</div></div>
        <div class='bubble'><div class='content'>2</div></div>
        <div class='bubble'><div class='content'>3</div><div class='tune-dot ottava'></div></div>
        <div class='bubble'><div class='content'>4</div><div class='tune-dot ottava-bassa'></div></div>
        <div class='bubble'><div class='content'>5</div></div>
      </div>
    </div>
    <p style='text-align: center; color: #888'>除数字、颜色外的记号均不影响游戏。其含义留给有兴趣的玩家自行探索。</p>
    <br>
    <p>一共有 5 次机会。游戏愉快~</p>
    <div class='bottom-shadow'></div>
  </div>
  <div class='modal hidden' id='modal-finish'>
    <p class='title'>- Medle #THUMB001 -</p>
    <p><strong>The Seventh Night of July</strong> by Itaru Sakai</p>
    <div id='answer-container'></div>
    <div class='list btn disabled' id='btn-play'>
      <div class='bg'>
        <div class='bubble' onclick='revealPlay()'>
          <div class='content'></div>
        </div>
      </div>
      <div class='fg'>
        <div class='bubble'><div class='content' id='btn-play-content'>…</div></div>
      </div>
    </div>
    <p>演出：The Band of the Royal Netherlands Air Force，指挥：Jan de Haan</p>
    <div id='btn-share'></div>
    <div class='bottom-shadow'></div>
  </div>
</div>

<script src='/static/howler.core.min.js'></script>
<script src='/static/clipboard.min.js'></script>
<script>
const tune = [
  [5-7, 4],
  [1, 6],
  [7-7, 1],
  [1, 1],
  [2, 2],
  [6-7, 1],
  [7-7, 1],
  [5-7, 4],
  [3, 4],
];
const tuneBeatDur = 200;
const tunePitchBase = 63;
const tuneRevealBeatDur = (5421 - 816) / 24;
const tuneRevealOffset = 816;

const N = tune.length;
const DECO_8VA = 1;
const DECO_8VB = 2;
const DECO_SHARP = 4;
const DECO_FLAT = 8;
const tuneDecos = tune.map(([a, b]) => {
  let r = 0;
  if (a < 1) r |= DECO_8VB;
  if (a > 7) r |= DECO_8VA;
  return r;
});
const tuneChromatic = !tuneDecos.every((r) => (r & (DECO_SHARP | DECO_FLAT)) === 0);
const tuneAnswer = tune.map(([a, b]) => (a + 6) % 7 + 1);

const SCALE = [0, 2, 4, 5, 7, 9, 11];

let tuneDur = 0;
for (const v of tune) {
  const t = v[1];
  v[1] = tuneDur;
  tuneDur += t;
}

const createRow = (decos, parentEl) => {
  const o = {};

  const n = decos.length;

  const div = (parentEl, classes) => {
    const el = document.createElement('div');
    if (typeof classes === 'string')
      el.classList.add(classes);
    else if (typeof classes === 'object')
      for (const cl of classes) el.classList.add(cl);
    parentEl.appendChild(el);
    return el;
  };

  const bgDivs = [];
  const fgDivs = [];
  const fgTexts = [];

  const el1 = div(parentEl, 'list');
  const el2 = div(el1, 'bg');
  const el3 = div(el1, 'fg');
  for (let i = 0; i < n; i++) {
    const el4a = div(el2, 'bubble');
    const el5a = div(el4a, 'content');
    const el4b = div(el3, 'bubble');
    const el5b = div(el4b, 'content');
    bgDivs.push(el4a);
    fgDivs.push(el4b);
    fgTexts.push(el5b);
    // Decoration?
    if (decos[i] & DECO_8VA) div(el5a, ['tune-dot', 'ottava']);
    if (decos[i] & DECO_8VB) div(el5a, ['tune-dot', 'ottava-bassa']);
  }

  o.fill = (i, s) => {
    bgDivs[i].classList.remove('hidden');
    fgDivs[i].classList.remove('hidden');
    bgDivs[i].classList.remove('outline');
    fgTexts[i].innerText = s;
  };
  o.clear = (i) => {
    bgDivs[i].classList.remove('hidden');
    bgDivs[i].classList.add('outline');
    fgDivs[i].classList.add('hidden');
  };
  o.style = (i, s) => {
    bgDivs[i].classList.add(s);
  };
  o.clearStyle = (i, s) => {
    bgDivs[i].classList.remove(s);
  };
  o.pop = (i) => {
    fgDivs[i].classList.add('large');
    bgDivs[i].classList.add('large');
    setTimeout(() => {
      fgDivs[i].classList.remove('large');
      bgDivs[i].classList.remove('large');
    }, 200);
  };
  o.show = (b) => {
    if (b) {
      for (let i = 0; i < n; i++) bgDivs[i].classList.remove('hidden');
      for (let i = 0; i < n; i++) fgDivs[i].classList.remove('hidden');
    } else {
      for (let i = 0; i < n; i++) bgDivs[i].classList.add('hidden');
      for (let i = 0; i < n; i++) fgDivs[i].classList.add('hidden');
    }
  };
  o.fast = (b) => {
    if (b) for (let i = 0; i < n; i++) bgDivs[i].classList.add('fast');
    else   for (let i = 0; i < n; i++) bgDivs[i].classList.remove('fast');
  };
  o.fastPop = (b) => {
    if (b) for (let i = 0; i < n; i++) bgDivs[i].classList.add('fast-pop');
    else   for (let i = 0; i < n; i++) bgDivs[i].classList.remove('fast-pop');
  };

  return o;
};

const check = (answer, guess) => {
  const n = answer.length;
  const result = Array(n).fill(0);
  for (let i = 0; i < n; i++)
    if (answer[i] === guess[i]) result[i] = 2;
  for (let i = 0; i < n; i++) if (result[i] !== 2) {
    // Look for the leftmost unmarked occurrence of answer[i] in the guess
    for (let j = 0; j < n; j++)
      if (result[j] === 0 && answer[i] === guess[j]) {
        result[j] = 1;
        break;
      }
  }
  return result;
};

const audios = {};
const paths = ['/static/samples/pop.wav'];
for (let i = -12; i <= 24; i++)
  if (tuneChromatic || SCALE.indexOf((i + 12) % 12) !== -1)
    paths.push(`/static/samples/pf-${tunePitchBase + i}.mp3`);

const preloadSounds = (callback) => {
  let count = 0;
  for (const path of paths) {
    const name = path.split('/').pop().split('.')[0];
    const audio = new Howl({src: [path]});
    audio.once('load', () => {
      callback(++count, paths.length);
    });
    audios[name] = audio;
  }
};

const playSound = (name, vol) => {
  audios[name].stop();
  audios[name].volume(vol !== undefined ? vol : 1);
  audios[name].play();
  return name;
};
const stopSound = (name, fade) => {
  if (fade) {
    audios[name].fade(audios[name].volume(), 0, 100);
  } else {
    audios[name].stop();
  }
};

const modalBackground = document.getElementById('modal-bg');
let curModal = null;
let curModalOnClose = undefined;

const showModal = (id, onClose) => {
  curModal = document.getElementById(id);
  curModal.classList.remove('hidden');
  modalBackground.classList.remove('hidden');
  curModalOnClose = onClose;
};
modalBackground.addEventListener('mouseup', () => {
  if (curModal !== null) curModal.classList.add('hidden');
  modalBackground.classList.add('hidden');
  if (curModalOnClose) curModalOnClose();
});

const loadingContainer = document.getElementById('text-loading');
const loadingProgress = document.getElementById('text-loading-progress');
const startButtonContainer = document.getElementById('btn-start');

const startGame = () => {
  startButtonContainer.classList.add('hidden');

  const listContainer = document.getElementById('list-container');
  const btnsRow1 = document.getElementById('input-btns-row-1');
  const btnsRow2 = document.getElementById('input-btns-row-2');
  const btnDelBg = document.getElementById('input-btn-del-bg');
  const btnsConfirm = document.getElementById('input-btns-confirm');
  const btnConfirmBg = document.getElementById('input-btn-confirm-bg');
  const btnsReveal = document.getElementById('input-btns-reveal');
  const btnRevealBg = document.getElementById('input-btn-reveal-bg');

  let curPfSound = undefined;
  const playForPos = (pos, solf, vol) => {
    const pitch = tunePitchBase + SCALE[solf - 1] +
      ((tuneDecos[pos] & DECO_8VA) ? 12 :
       (tuneDecos[pos] & DECO_8VB) ? -12 : 0);
    if (curPfSound !== undefined) stopSound(curPfSound, true);
    curPfSound = playSound(`pf-${pitch}`, vol);
  };

  const curInput = [];
  const attempts = [];
  let succeeded = false;

  const pickVisibleButtons = () => {
    if (attempts.length === 5 || succeeded) {
      btnsRow1.classList.add('hidden');
      btnsRow2.classList.add('hidden');
      btnsRow2.classList.add('must');
      btnsConfirm.classList.add('hidden');
      btnsReveal.classList.remove('hidden');
      recalcConfirmWidth();
      return;
    }
    btnsReveal.classList.add('hidden');
    if (curInput.length < N) {
      btnsRow1.classList.remove('hidden');
      btnsRow2.classList.remove('hidden');
      btnsConfirm.classList.add('hidden');
    } else {
      btnsRow1.classList.add('hidden');
      btnsRow2.classList.add('hidden');
      btnsConfirm.classList.remove('hidden');
      recalcConfirmWidth();
    }
  };
  const showButtons = (b) => {
    if (b) {
      btnsRow1.classList.remove('hidden');
      btnsRow2.classList.remove('hidden');
      btnsRow2.classList.remove('must');
      btnsConfirm.classList.remove('hidden');
      btnsReveal.classList.remove('hidden');
      pickVisibleButtons();
    } else {
      btnsRow1.classList.add('hidden');
      btnsRow2.classList.add('hidden');
      btnsRow2.classList.add('must');
      btnsConfirm.classList.add('hidden');
      btnsReveal.classList.add('hidden');
    }
  };

  const initialRow = createRow(tuneDecos, listContainer);
  initialRow.fast(true);
  initialRow.show(false);

  for (const [i, [a, b]] of Object.entries(tune)) {
    setTimeout(() => {
      initialRow.fill(i, '');
      playSound('pop', 0.5);
    }, b * tuneBeatDur + 20);
  }
  setTimeout(() => {
    for (let i = 0; i < N; i++) initialRow.clear(i);
    initialRow.fast(false);
  }, tuneDur * tuneBeatDur);
  setTimeout(() => showButtons(true), tuneDur * tuneBeatDur + 1000);

  const recalcConfirmWidth = () => {
    const rect = btnDelBg.getBoundingClientRect();
    const vw = document.body.clientWidth;
    const w = vw - 2 * (vw - rect.right);
    btnConfirmBg.style.width = (w / 1.2) + 'px';
  };
  window.addEventListener('resize', recalcConfirmWidth);

  let r = initialRow;

  window.input = (i) => {
    if (i === -1 && curInput.length > 0) {
      curInput.pop();
      r.clear(curInput.length);
    } else if (i !== -1 && curInput.length < N) {
      r.fill(curInput.length, i.toString());
      curInput.push(i);
      playForPos(curInput.length - 1, i);
    }
    pickVisibleButtons();
  };

  window.confirmGuess = () => {
    showButtons(false);
    const result = check(tuneAnswer, curInput);
    for (const [i, [a, b]] of Object.entries(tune)) {
      setTimeout(() => {
        r.pop(i);
        if (result[i] === 0) r.style(i, 'none');
        if (result[i] === 1) r.style(i, 'maybe');
        if (result[i] === 2) r.style(i, 'bingo');
        playForPos(i, curInput[i], result[i] === 2 ? 1 : 0.2);
        if (result[i] !== 2) playSound('pop', 0.2);
      }, 500 + b * tuneBeatDur);
    }
    attempts.push(result);
    setTimeout(() => {
      succeeded = result.every((r) => r === 2);
      if (attempts.length === 5 || succeeded) {
        window.revealAnswer();
        showButtons(true);
      } else {
        r = createRow(tuneDecos, listContainer);
        r.show(false);
        setTimeout(() => {
          for (let i = 0; i < N; i++) r.clear(i);
        }, 10);
        curInput.splice(0);
        showButtons(true);
      }
    }, 500 + tuneDur * tuneBeatDur + 1000);
  };

  const answerContainer = document.getElementById('answer-container');
  const answerRow = createRow(tuneDecos, answerContainer);
  for (let i = 0; i < N; i++)
    answerRow.fill(i, tuneAnswer[i]);
  answerRow.fastPop(true);

  const btnShare = document.getElementById('btn-share');
  new ClipboardJS(btnShare, {
    text: () => {
      btnShare.innerText = '✓ 已复制到剪贴板';
      btnShare.classList.add('copied');
      const prefix = `Medle #THUMB001 ${succeeded ? attempts.length : 'X'}/5\n`;
      return prefix +
        attempts.map((result) => result.map((r) => {
          if (r === 0) return '\u{26aa}';
          if (r === 1) return '\u{1f7e1}';
          if (r === 2) return '\u{1f7e2}';
        }).join('')).join('\n');
    }
  });

  let answerAudioLoading = false;
  let answerAudio;
  const btnPlay = document.getElementById('btn-play');
  const btnPlayContent = document.getElementById('btn-play-content');

  let fadeOutTimer = -1;
  let playing = false;
  const updatePlayButtonText = () => {
    btnPlayContent.innerText = (playing ? 'Stop' : 'Play');
  };

  let revealBubbleTimers = [];
  const createBubbleTimers = () => {
    for (let i = 0; i < N; i++) {
      const t = setTimeout(
        () => {
          answerRow.pop(i);
          answerRow.style(i, 'bingo');
        },
        tune[i][1] * tuneRevealBeatDur + tuneRevealOffset - 100);
      revealBubbleTimers.push(t);
    }
  };
  const stopBubbleTimers = () => {
    for (const t of revealBubbleTimers) clearTimeout(t);
    revealBubbleTimers.splice(0);
    for (let i = 0; i < N; i++) answerRow.clearStyle(i, 'bingo');
  };

  window.revealAnswer = () => {
    btnShare.innerText = '分享';
    btnShare.classList.remove('copied');

    showModal('modal-finish', () => {
      if (playing) window.revealPlay();
    });
    playing = false;

    if (!answerAudioLoading) {
      answerAudioLoading = true;
      answerAudio = new Howl({src: ['/reveal/THUMB001.mp3']});
      answerAudio.once('load', () => {
        btnPlay.classList.remove('disabled');
        updatePlayButtonText();
      });
      answerAudio.on('end', () => {
        playing = false;
        updatePlayButtonText();
        stopBubbleTimers();
      });
    }

    for (let i = 0; i < N; i++)
      answerRow.clearStyle(i, 'bingo');
  };

  window.revealPlay = () => {
    if (fadeOutTimer !== -1) clearTimeout(fadeOutTimer);
    if (playing) {
      answerAudio.fade(1, 0, 100);
      fadeOutTimer = setTimeout(
        () => answerAudio.stop(),
        120);
      stopBubbleTimers();
    } else {
      answerAudio.stop();
      answerAudio.fade(0, 1, 100);
      answerAudio.play();
      fadeOutTimer = setTimeout(
        () => answerAudio.fade(1, 0, 100),
        answerAudio.duration() * 1000 - 120);
      createBubbleTimers();
    }
    playing = !playing;
    updatePlayButtonText();
  };
};

preloadSounds((loaded, total) => {
  loadingProgress.innerText = `${loaded}/${total}`;
  if (loaded === total) {
    loadingContainer.classList.add('hidden');
    startButtonContainer.classList.remove('hidden');
  }
});

if (localStorage.first === undefined) {
  showModal('modal-intro');
  localStorage.first = '';
}

document.getElementById('icon-btns-container').addEventListener('click', () => {
  showModal('modal-intro');
});
</script>

</body></html>
